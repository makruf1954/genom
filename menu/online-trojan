#!/bin/bash

# Warna
DF='\e[39m'
Bold='\e[1m'
Blink='\e[5m'
yell='\e[33m'
red='\e[31m'
green='\e[32m'
blue='\e[34m'
PURPLE='\e[35m'
cyan='\e[36m'
Lred='\e[91m'
Lgreen='\e[92m'
Lyellow='\e[93m'
NC='\e[0m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
LIGHT='\033[0;37m'
grenbo="\e[92;1m"

clear

# Fungsi konversi byte
function con() {
    local -i bytes=$1
    if [[ $bytes -lt 1024 ]]; then
        echo "${bytes}B"
    elif [[ $bytes -lt 1048576 ]]; then
        echo "$(( (bytes + 1023)/1024 ))KB"
    elif [[ $bytes -lt 1073741824 ]]; then
        echo "$(( (bytes + 1048575)/1048576 ))MB"
    else
        echo "$(( (bytes + 1073741823)/1073741824 ))GB"
    fi
}

# Mulai pengecekan akun trojan
echo -n > /tmp/other.txt
data=( $(grep "^#trg" /etc/xray/config.json | cut -d ' ' -f 2 | sort | uniq) )

echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e " \e[1;97;101m           CEK TROJAN ACCOUNT           \e[0m"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

for akun in "${data[@]}"; do
    [[ -z "$akun" ]] && continue

    echo -n > /tmp/iptrojan.txt
    data2=( $(tail -n 500 /var/log/xray/access.log | cut -d " " -f 3 | sed 's/tcp://g' | cut -d ":" -f 1 | sort | uniq) )

    for ip in "${data2[@]}"; do
        jum=$(grep -w "$akun" /var/log/xray/access.log | tail -n 500 | cut -d " " -f 3 | sed 's/tcp://g' | cut -d ":" -f 1 | grep -w "$ip" | sort | uniq)
        if [[ "$jum" == "$ip" ]]; then
            echo "$jum" >> /tmp/iptrojan.txt
        else
            echo "$ip" >> /tmp/other.txt
        fi
        jum2=$(cat /tmp/iptrojan.txt)
        sed -i "/$jum2/d" /tmp/other.txt > /dev/null 2>&1
    done

    jum=$(cat /tmp/iptrojan.txt)
    if [[ -n "$jum" ]]; then
        # Cek file akun dan data terkait
        akun_file="/etc/trojan/akun/${akun}"
        limit_file="/etc/limit/trojan/${akun}"
        quota_file="/etc/trojan/${akun}"

        # Ambil nilai IP limit
        if [[ -f "$akun_file" ]]; then
            iplimit=$(grep ^login_ip "$akun_file" | cut -d= -f2)
        else
            iplimit="?"
        fi

        # Ambil quota limit dan usage
        if [[ -f "$limit_file" ]]; then
            wey=$(cat "$limit_file")
            gb=$(con "$wey")
        else
            gb="0B"
        fi

        if [[ -f "$quota_file" ]]; then
            byte=$(cat "$quota_file")
            lim=$(con "$byte")
        else
            lim="0B"
        fi

        lastlogin=$(grep -w "$akun" /var/log/xray/access.log | tail -n 500 | cut -d " " -f 2 | tail -1)
        jum2=$(wc -l < /tmp/iptrojan.txt)

        echo -e " \033[1;36m┌──────────────────────────────────────┐\033[0m"
        printf "  %-13s %s\n" "UserName :" "$akun"
        printf "  %-13s %s\n" "Login    :" "$lastlogin"
        printf "  %-13s %s\n" "Usage Quota :" "$gb"
        printf "  %-13s %s\n" "Limit Quota :" "$lim"
        printf "  %-13s %s\n" "Limit IP :" "$iplimit"
        printf "  %-13s %s\n" "Login IP :" "$jum2"
        echo -e " \033[1;36m└──────────────────────────────────────┘\033[0m"
    fi

    rm -f /tmp/iptrojan.txt
done

rm -f /tmp/other.txt
echo ""
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo ""
